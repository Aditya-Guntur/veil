# ğŸ­ VEIL Architecture

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         PRESENTATION LAYER                          â”‚
â”‚                     (React + TypeScript Frontend)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-â”€â”          â”‚
â”‚  â”‚  Landing     â”‚    â”‚  Trading     â”‚    â”‚  Results      â”‚          â”‚
â”‚  â”‚  Page        â”‚    â”‚  Page        â”‚    â”‚  Page         â”‚          â”‚
â”‚  â”‚              â”‚    â”‚              â”‚    â”‚               â”‚          â”‚
â”‚  â”‚  â€¢ Hero      â”‚    â”‚  â€¢ Timer     â”‚    â”‚  â€¢ Price      â”‚          â”‚
â”‚  â”‚  â€¢ Features  â”‚    â”‚  â€¢ OrderForm â”‚    â”‚  â€¢ Stats      â”‚          â”‚
â”‚  â”‚  â€¢ CTA       â”‚    â”‚  â€¢ OrderBook â”‚    â”‚  â€¢ Leaderboardâ”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-â”€â”˜          â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚            State Management & Hooks                     â”‚        â”‚
â”‚  â”‚  â€¢ useAuth (Internet Identity)                          â”‚        â”‚
â”‚  â”‚  â€¢ useCountdown (Real-time timer)                       â”‚        â”‚
â”‚  â”‚  â€¢ canisterService (Actor wrapper)                      â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ @dfinity/agent (Candid Interface)
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         APPLICATION LAYER                           â”‚
â”‚                  (Internet Computer Canisters)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚          mempool_chess_backend (Main Canister)                â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚  â”‚
â”‚  â”‚  â”‚   lib.rs    â”‚  â”‚  types.rs   â”‚  â”‚ auction.rs  â”‚            â”‚  â”‚
â”‚  â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚            â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ STATE     â”‚  â”‚ â€¢ Order     â”‚  â”‚ â€¢ Clearing  â”‚            â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ STORAGE   â”‚  â”‚ â€¢ Round     â”‚  â”‚   Algorithm â”‚            â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Endpoints â”‚  â”‚ â€¢ Results   â”‚  â”‚ â€¢ Supply/   â”‚            â”‚  â”‚
â”‚  â”‚  â”‚             â”‚  â”‚ â€¢ Stats     â”‚  â”‚   Demand    â”‚            â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚  â”‚ 
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚  â”‚
â”‚  â”‚  â”‚encryption.rsâ”‚  â”‚  timers.rs  â”‚  â”‚ queries.rs  â”‚            â”‚  â”‚
â”‚  â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚            â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ vetKeys   â”‚  â”‚ â€¢ Heartbeat â”‚  â”‚ â€¢ User Data â”‚            â”‚  â”‚
â”‚  â”‚  â”‚   Bridge    â”‚  â”‚ â€¢ Auto      â”‚  â”‚ â€¢ Leaderboardâ”‚           â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Decrypt   â”‚  â”‚   Progress  â”‚  â”‚ â€¢ OrderBook â”‚            â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚     ethereum.rs          â”‚  â”‚      bitcoin.rs          â”‚   â”‚  |
â”‚  â”‚  â”‚                          â”‚  â”‚                          â”‚   â”‚  |
â”‚  â”‚  â”‚ â€¢ Threshold ECDSA        â”‚  â”‚ â€¢ Threshold Schnorr      â”‚   â”‚  |
â”‚  â”‚  â”‚ â€¢ EIP-1559 Transactions  â”‚  â”‚ â€¢ UTXO Management        â”‚   â”‚  |  
â”‚  â”‚  â”‚ â€¢ Uniswap Integration    â”‚  â”‚ â€¢ Transaction Building   â”‚   â”‚  |
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              vetkeys_engine (Encryption Canister)             â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  â€¢ get_encryption_public_key() â†’ Master public key            â”‚  â”‚
â”‚  â”‚  â€¢ derive_round_key(round_id) â†’ Timelock-based key            â”‚  â”‚
â”‚  â”‚  â€¢ derive_user_key(principal) â†’ User-specific key             â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  Production: Uses ICP vetKD API (BLS12-381 threshold)         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚          internet_identity (Authentication Canister)          â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  â€¢ WebAuthn / Passkey authentication                          â”‚  â”‚
â”‚  â”‚  â€¢ Returns Principal + Identity                               â”‚  â”‚
â”‚  â”‚  â€¢ Session management                                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ Threshold Cryptography
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SETTLEMENT LAYER                            â”‚
â”‚                      (External Blockchains)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   Bitcoin Network      â”‚          â”‚   Ethereum Network     â”‚     â”‚
â”‚  â”‚                        â”‚          â”‚                        â”‚     â”‚
â”‚  â”‚  â€¢ Threshold Schnorr   â”‚          â”‚  â€¢ Threshold ECDSA     â”‚     â”‚
â”‚  â”‚  â€¢ Native BTC Control  â”‚          â”‚  â€¢ Native ETH Control  â”‚     â”‚
â”‚  â”‚  â€¢ UTXO Management     â”‚          â”‚  â€¢ EIP-1559 Txs        â”‚     â”‚
â”‚  â”‚  â€¢ No Bridges          â”‚          â”‚  â€¢ Uniswap Swaps       â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow: Complete Round Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     PHASE 1: ORDER SUBMISSION                       â”‚
â”‚                        (Active - 60 seconds)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    User                  Frontend              Backend              Storage
     â”‚                       â”‚                     â”‚                    â”‚
     â”‚  1. Fill Form         â”‚                     â”‚                    â”‚
     â”‚  (Buy 10 ETH          â”‚                     â”‚                    â”‚
     â”‚   @ $3,100)           â”‚                     â”‚                    â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚                    â”‚
     â”‚                       â”‚                     â”‚                    â”‚
     â”‚                       â”‚  2. submit_order()  â”‚                    â”‚
     â”‚                       â”‚  â€¢ order_type       â”‚                    â”‚
     â”‚                       â”‚  â€¢ amount (wei)     â”‚                    â”‚
     â”‚                       â”‚  â€¢ price (cents)    â”‚                    â”‚
     â”‚                       â”‚  â€¢ encrypted_payloadâ”‚                    â”‚
     â”‚                       â”‚  â€¢ commitment_hash  â”‚                    â”‚
     â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
     â”‚                       â”‚                     â”‚                    â”‚
     â”‚                       â”‚                     â”‚  3. Validate       â”‚
     â”‚                       â”‚                     â”‚  â€¢ Check Active    â”‚
     â”‚                       â”‚                     â”‚  â€¢ Lock funds      â”‚
     â”‚                       â”‚                     â”‚  â€¢ Generate ID     â”‚
     â”‚                       â”‚                     â”‚                    â”‚
     â”‚                       â”‚                     â”‚  4. Store Order    â”‚
     â”‚                       â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                       â”‚                     â”‚                    â”‚
     â”‚                       â”‚  5. Return order_id â”‚                    â”‚
     â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
     â”‚                       â”‚                     â”‚                    â”‚
     â”‚  6. Success Toast     â”‚                     â”‚                    â”‚
     â”‚  "Order #42 "         â”‚                     â”‚                    â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚                    â”‚


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PHASE 2: TIMELOCK EXPIRY                         â”‚
â”‚                      (Revealing State)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Heartbeat            Main Canister        vetkeys_engine         Orders
     â”‚                      â”‚                      â”‚                  â”‚
     â”‚  Timer expires       â”‚                      â”‚                  â”‚
     â”‚  (60 seconds)        â”‚                      â”‚                  â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚                  â”‚
     â”‚                      â”‚                      â”‚                  â”‚
     â”‚                      â”‚  Change State:       â”‚                  â”‚
     â”‚                      â”‚  RoundState::        â”‚                  â”‚
     â”‚                      â”‚  Revealing           â”‚                  â”‚
     â”‚                      â”‚                      â”‚                  â”‚
     â”‚                      â”‚  Fetch orders for    â”‚                  â”‚
     â”‚                      â”‚  current round_id    â”‚                  â”‚
     â”‚                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                      â”‚                      â”‚                  â”‚
     â”‚                      â”‚  derive_round_key()  â”‚                  â”‚
     â”‚                      â”‚  (round_id)          â”‚                  â”‚
     â”‚                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚
     â”‚                      â”‚                      â”‚                  â”‚
     â”‚                      â”‚                      â”‚  Threshold       â”‚
     â”‚                      â”‚                      â”‚  Network         â”‚
     â”‚                      â”‚                      â”‚  Derives Key     â”‚
     â”‚                      â”‚                      â”‚                  â”‚
     â”‚                      â”‚  Decryption Key      â”‚                  â”‚
     â”‚                      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚
     â”‚                      â”‚                      â”‚                  â”‚
     â”‚                      â”‚  Decrypt batch:      â”‚                  â”‚
     â”‚                      â”‚  â€¢ Verify commitment â”‚                  â”‚
     â”‚                      â”‚  â€¢ Return plaintext  â”‚                  â”‚


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   PHASE 3: PRICE DISCOVERY                          â”‚
â”‚                      (Clearing State)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                         auction.rs
                            â”‚
                            â”‚  find_clearing_price_and_match()
                            â”‚
                            â”œâ”€â”€> 1. Separate Orders
                            â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚    â”‚  Buys    â”‚  â”‚  Sells   â”‚
                            â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”œâ”€â”€> 2. Sort Orders
                            â”‚    â€¢ Buys: HIGH â†’ LOW
                            â”‚    â€¢ Sells: LOW â†’ HIGH
                            â”‚
                            â”œâ”€â”€> 3. Build Cumulative Curves
                            â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚    â”‚ Price | Demand | Supplyâ”‚
                            â”‚    â”‚ $3100 | 10 ETH | 0 ETH â”‚
                            â”‚    â”‚ $3005 | 60 ETH | 15 ETHâ”‚
                            â”‚    â”‚ $3001 | 60 ETH | 60 ETHâ”‚ â† MATCH!
                            â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”œâ”€â”€> 4. Find Intersection
                            â”‚    â€¢ Max volume: 60 ETH
                            â”‚    â€¢ Clearing price: $3,001
                            â”‚
                            â”œâ”€â”€> 5. Match Orders
                            â”‚    â€¢ Calculate fills
                            â”‚    â€¢ Calculate surplus
                            â”‚    â€¢ Mark filled/unfilled
                            â”‚
                            â””â”€â”€> 6. Return ClearingResult
                                 â€¢ clearing_price: $3,001
                                 â€¢ total_volume: 60 ETH
                                 â€¢ total_surplus: $1,300
                                 â€¢ matches: Vec<OrderMatch>


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PHASE 4: SETTLEMENT                              â”‚
â”‚                    (Executing State)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Main Canister        Ethereum Module       Bitcoin Module
         â”‚                     â”‚                      â”‚
         â”‚  Calculate Net      â”‚                      â”‚
         â”‚  Position:          â”‚                      â”‚
         â”‚  â€¢ Buy: 60 ETH      â”‚                      â”‚
         â”‚  â€¢ Sell: 60 ETH     â”‚                      â”‚
         â”‚  â€¢ Net: 0 (balanced)â”‚                      â”‚
         â”‚                     â”‚                      â”‚
         â”‚  If net != 0:       â”‚                      â”‚
         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚                     â”‚                      â”‚
         â”‚  execute_eth_       â”‚                      â”‚
         â”‚  settlement()       â”‚                      â”‚
         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚
         â”‚                     â”‚                      â”‚
         â”‚                     â”‚  1. Get ETH address  â”‚
         â”‚                     â”‚  (derive from        â”‚
         â”‚                     â”‚   threshold ECDSA)   â”‚
         â”‚                     â”‚                      â”‚
         â”‚                     â”‚  2. Build EIP-1559   â”‚
         â”‚                     â”‚  transaction         â”‚
         â”‚                     â”‚                      â”‚
         â”‚                     â”‚  3. Sign with        â”‚
         â”‚                     â”‚  IC threshold ECDSA  â”‚
         â”‚                     â”‚                      â”‚
         â”‚                     â”‚  4. Broadcast to     â”‚
         â”‚                     â”‚  Ethereum network    â”‚
         â”‚                     â”‚                      â”‚
         â”‚                     â”‚                      â”‚
         â”‚  execute_btc_       â”‚                      â”‚
         â”‚  settlement()       â”‚                      â”‚
         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
         â”‚                     â”‚                      â”‚
         â”‚                     â”‚              1. Get BTC address
         â”‚                     â”‚              (threshold Schnorr)
         â”‚                     â”‚                      â”‚
         â”‚                     â”‚              2. Get UTXOs
         â”‚                     â”‚              (HTTPS outcall)
         â”‚                     â”‚                      â”‚
         â”‚                     â”‚              3. Build BTC tx
         â”‚                     â”‚                      â”‚
         â”‚                     â”‚              4. Sign with
         â”‚                     â”‚              threshold Schnorr
         â”‚                     â”‚                      â”‚
         â”‚                     â”‚              5. Broadcast
         â”‚                     â”‚                      â”‚
         â”‚  Settlement         â”‚                      â”‚
         â”‚  Complete           â”‚                      â”‚
         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚  Update State:
         â”‚  RoundState::Completed


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PHASE 5: COMPLETION                              â”‚
â”‚                 (Wait 15s â†’ Start New Round)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Heartbeat           Main Canister         User Stats         Frontend
     â”‚                      â”‚                    â”‚                 â”‚
     â”‚  Wait 15 seconds     â”‚                    â”‚                 â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                 â”‚
     â”‚                      â”‚                    â”‚                 â”‚
     â”‚                      â”‚  Update stats:     â”‚                 â”‚
     â”‚                      â”‚  â€¢ total_orders    â”‚                 â”‚
     â”‚                      â”‚  â€¢ filled_orders   â”‚                 â”‚
     â”‚                      â”‚  â€¢ total_surplus   â”‚                 â”‚
     â”‚                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚
     â”‚                      â”‚                    â”‚                 â”‚
     â”‚                      â”‚  Start new round:  â”‚                 â”‚
     â”‚                      â”‚  â€¢ round_id++      â”‚                 â”‚
     â”‚                      â”‚  â€¢ State = Active  â”‚                 â”‚
     â”‚                      â”‚  â€¢ Reset timer     â”‚                 â”‚
     â”‚                      â”‚                    â”‚                 â”‚
     â”‚                      â”‚  Notify frontend   â”‚                 â”‚
     â”‚                      â”‚  (via polling)     â”‚                 â”‚
     â”‚                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                      â”‚                    â”‚                 â”‚
     â”‚                      â”‚                    â”‚  Display Results
     â”‚                      â”‚                    â”‚  â€¢ Clearing Price
     â”‚                      â”‚                    â”‚  â€¢ Leaderboard
     â”‚                      â”‚                    â”‚  â€¢ User Surplus
```

---

## Storage Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         STABLE MEMORY                               â”‚
â”‚                    (Persists Across Upgrades)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ORDERS: StableBTreeMap<OrderId, Order>                       â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  Key: u64 (order_id)                                          â”‚  â”‚
â”‚  â”‚  Value: Order {                                               â”‚  â”‚
â”‚  â”‚    id, round_id, owner, order_type,                           â”‚  â”‚
â”‚  â”‚    asset, amount, price_limit,                                â”‚  â”‚
â”‚  â”‚    encrypted_payload, commitment_hash                         â”‚  â”‚
â”‚  â”‚  }                                                            â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  Indexed by: order_id, round_id, owner                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  RESULTS: StableBTreeMap<RoundId, ClearingResult>             â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  Key: u64 (round_id)                                          â”‚  â”‚
â”‚  â”‚  Value: ClearingResult {                                      â”‚  â”‚
â”‚  â”‚    round_id, clearing_price,                                  â”‚  â”‚
â”‚  â”‚    total_volume, total_surplus,                               â”‚  â”‚
â”‚  â”‚    matches: Vec<OrderMatch>,                                  â”‚  â”‚
â”‚  â”‚    timestamp                                                  â”‚  â”‚
â”‚  â”‚  }                                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         HEAP MEMORY                                â”‚
â”‚                    (Cached, Rebuilt on Upgrade)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  STATE: RefCell<State>                                        â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  â€¢ round_id: u64                                              â”‚ â”‚
â”‚  â”‚  â€¢ round_state: RoundState (enum)                             â”‚ â”‚
â”‚  â”‚  â€¢ round_start_time: u64                                      â”‚ â”‚
â”‚  â”‚  â€¢ round_duration_ns: u64                                     â”‚ â”‚
â”‚  â”‚  â€¢ next_order_id: u64                                         â”‚ â”‚
â”‚  â”‚  â€¢ clearing_price_history: Vec<u64>                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  USER_STATS: HashMap<Principal, UserStats>                    â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  Key: Principal (user identity)                               â”‚ â”‚
â”‚  â”‚  Value: UserStats {                                           â”‚ â”‚
â”‚  â”‚    user, total_orders, filled_orders,                         â”‚ â”‚
â”‚  â”‚    total_surplus, rounds_participated                         â”‚ â”‚
â”‚  â”‚  }                                                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  DEMO_BALANCES: HashMap<Principal, DemoUserBalance>           â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  Key: Principal                                               â”‚ â”‚
â”‚  â”‚  Value: DemoUserBalance {                                     â”‚ â”‚
â”‚  â”‚    btc_free, btc_locked,                                      â”‚ â”‚
â”‚  â”‚    usd_free, usd_locked                                       â”‚ â”‚
â”‚  â”‚  }                                                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Security Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CRYPTOGRAPHIC SECURITY                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Layer 1: Timelock Encryption (vetKeys)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-â”€â”       â”‚
â”‚  â”‚  â€¢ Orders encrypted with future timestamp                â”‚       â”‚
â”‚  â”‚  â€¢ Threshold network enforces decryption timing          â”‚       â”‚
â”‚  â”‚  â€¢ Cannot decrypt before timelock expires                â”‚       â”‚
â”‚  â”‚  â€¢ No single party (including canister) can decrypt earlyâ”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-â”€â”˜       â”‚
â”‚                                                                     â”‚
â”‚  Layer 2: Commitment Scheme                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-â”€â”       â”‚
â”‚  â”‚  At Submission:                                          â”‚       â”‚
â”‚  â”‚    commitment_hash = SHA256(order_data)                  â”‚       â”‚
â”‚  â”‚                                                          â”‚       â”‚
â”‚  â”‚  At Reveal:                                              â”‚       â”‚
â”‚  â”‚    verify(decrypted_data) == commitment_hash             â”‚       â”‚
â”‚  â”‚                                                          â”‚       â”‚
â”‚  â”‚  Prevents: Order tampering after submission              â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-â”€â”€â”€â”˜       â”‚
â”‚                                                                     â”‚
â”‚  Layer 3: Threshold Signatures                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-â”€â”€â”       â”‚
â”‚  â”‚  â€¢ Bitcoin: Threshold Schnorr (chain-key)                â”‚       â”‚
â”‚  â”‚  â€¢ Ethereum: Threshold ECDSA (chain-key)                 â”‚       â”‚
â”‚  â”‚  â€¢ No single node controls private keys                  â”‚       â”‚
â”‚  â”‚  â€¢ Subnet consensus required for signing                 â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      APPLICATION SECURITY                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Layer 4: Escrow & Fund Locking                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  At Order Submission:                                    â”‚       â”‚
â”‚  â”‚    â€¢ Lock required funds in DEMO_BALANCES                â”‚       â”‚
â”‚  â”‚    â€¢ Buy: Lock (amount Ã— price_limit) USD                â”‚       â”‚
â”‚  â”‚    â€¢ Sell: Lock amount BTC                               â”‚       â”‚
â”‚  â”‚                                                          â”‚       â”‚
â”‚  â”‚  At Settlement:                                          â”‚       â”‚
â”‚  â”‚    â€¢ Release locked funds                                â”‚       â”‚
â”‚  â”‚    â€¢ Transfer assets based on clearing price             â”‚       â”‚
â”‚  â”‚    â€¢ Refund surplus to users                             â”‚       â”‚
â”‚  â”‚                                                          â”‚       â”‚
â”‚  â”‚  Prevents: Double-spending, insufficient funds           â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                     â”‚
â”‚  Layer 5: Access Control                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  â€¢ Internet Identity authentication required             â”‚       â”‚
â”‚  â”‚  â€¢ Only order owner can view their plaintext orders      â”‚       â”‚
â”‚  â”‚  â€¢ Admin functions restricted to canister controller     â”‚       â”‚
â”‚  â”‚  â€¢ Query calls vs Update calls separation                â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-â”€â”€â”€â”˜       â”‚
â”‚                                                                     â”‚
â”‚  Layer 6: State Integrity                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  â€¢ Stable storage persists across upgrades               â”‚       â”‚
â”‚  â”‚  â€¢ Round state machine enforced                          â”‚       â”‚
â”‚  â”‚  â€¢ Atomic state transitions                              â”‚       â”‚
â”‚  â”‚  â€¢ Rollback on errors                                    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Module Dependencies

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            lib.rs                                   â”‚
â”‚                      (Main Orchestrator)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€-â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                                â”‚
         â”œâ”€â”€> types.rs (Data Structures)                  â”‚
         â”‚    â€¢ Order, ClearingResult, State              â”‚
         â”‚    â€¢ RoundState enum, UserStats                â”‚
         â”‚                                                â”‚
         â”œâ”€â”€> auction.rs (Price Discovery)                â”‚
         â”‚    â€¢ find_clearing_price_and_match()           â”‚
         â”‚    â€¢ Supply/demand curve calculation           â”‚
         â”‚                                                â”‚
         â”œâ”€â”€> encryption.rs (vetKeys Bridge) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”
         â”‚    â€¢ get_encryption_public_key()               â”‚     â”‚
         â”‚    â€¢ derive_round_decryption_key()             â”‚     â”‚
         â”‚    â€¢ decrypt_order_batch()                     â”‚     â”‚
         â”‚                                                â”‚     â”‚
         â”œâ”€â”€> timers.rs (Automation)                      â”‚     â”‚
         â”‚    â€¢ start_round_timer()                       â”‚     â”‚
         â”‚    â€¢ check_and_progress_round()                â”‚     â”‚
         â”‚    â€¢ auto_start_next_round()                   â”‚     â”‚
         â”‚                                                â”‚     â”‚
         â”œâ”€â”€> queries.rs (Data Access)                    â”‚     â”‚
         â”‚    â€¢ get_user_orders()                         â”‚     â”‚
         â”‚    â€¢ get_round_leaderboard()                   â”‚     â”‚
         â”‚    â€¢ get_order_book_summary()                  â”‚     â”‚
         â”‚                                                â”‚     â”‚
         â”œâ”€â”€> ethereum.rs (Chain Fusion - ETH)            â”‚     â”‚
         â”‚    â€¢ get_eth_address()                         â”‚     â”‚
         â”‚    â€¢ sign_eth_transaction()                    â”‚     â”‚
         â”‚    â€¢ execute_eth_settlement()                  â”‚     â”‚
         â”‚                                                â”‚     â”‚
         â””â”€â”€> bitcoin.rs (Chain Fusion - BTC)             â”‚     â”‚
              â€¢ get_btc_address()                         â”‚     â”‚
              â€¢ sign_btc_transaction()                    â”‚     â”‚
              â€¢ execute_btc_settlement()                  â”‚     â”‚
                                                          â”‚     â”‚
                                                          â†“     â”‚
                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
                                              â”‚  vetkeys_engine       â”‚
                                              â”‚  (Separate Canister)  â”‚
                                              â”‚                       â”‚
                                              â”‚  â€¢ get_public_key()   â”‚
                                              â”‚  â€¢ derive_round_key() â”‚
                                              â”‚  â€¢ derive_user_key()  â”‚
                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Component Interaction Matrix

| Component | Calls | Called By | Storage Access | External Calls |
|-----------|-------|-----------|----------------|----------------|
| **lib.rs** | All modules | Frontend via Candid | ORDERS, RESULTS, STATE | vetkeys_engine, II |
| **auction.rs** | types.rs | lib.rs | Read ORDERS | None |
| **encryption.rs** | â€” | lib.rs | None | vetkeys_engine |
| **timers.rs** | lib.rs | IC Heartbeat | STATE | None |
| **queries.rs** | types.rs | Frontend | ORDERS, RESULTS, USER_STATS | None |
| **ethereum.rs** | â€” | lib.rs | None | IC Management (ECDSA) |
| **bitcoin.rs** | â€” | lib.rs | None | IC Management (Schnorr) |
| **vetkeys_engine** | â€” | encryption.rs | None | IC vetKD API |

---
